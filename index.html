<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milk Tea Finance Tracker v4</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§‹</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- å¥¶èŒ¶è‰²ç³»è®Šæ•¸ --- */
        :root {
            --bg-color: #F7F5F2;
            --card-bg: #FFFFFF;
            --primary-color: #C59D7F;
            --primary-dark: #8D7B68;
            --accent-color: #D4A373;
            --text-main: #4A403A;
            --text-muted: #9C8E83;
            --success-color: #A3B18A;
            --danger-color: #D58989;
            --transfer-color: #8D99AE;
            
            --radius-lg: 24px;
            --radius-sm: 12px;
            --shadow-soft: 0 10px 40px -10px rgba(197, 157, 127, 0.15);
            --shadow-hover: 0 20px 50px -12px rgba(197, 157, 127, 0.25);
            
            --grid-gap: 20px;
            
            --bg-image: radial-gradient(var(--primary-color) 1px, transparent 1px);
            --bg-size: 30px 30px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Nunito', 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
            background-image: var(--bg-image);
            background-size: var(--bg-size);
            position: relative;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding-bottom: 40px;
        }

        /* Header */
        header {
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header-title h1 {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-left: 42px;
        }
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Utility Buttons */
        .btn-sm {
            font-size: 0.85rem;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid var(--primary-color);
            background: white;
            color: var(--primary-dark);
            font-weight: 700;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
        }
        .btn-sm:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: var(--grid-gap);
            grid-auto-rows: minmax(min-content, max-content);
        }

        /* Widget Base */
        .widget {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(255,255,255,0.6);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .widget-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            border-bottom: 2px solid #F4F1EE;
            padding-bottom: 10px;
            flex-shrink: 0;
        }

        /* --- Account Cards (Top Row) --- */
        .accounts-row {
            grid-column: span 12;
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 accounts */
            gap: 15px;
        }
        .account-card {
            background: #FFF;
            padding: 15px;
            border-radius: var(--radius-sm);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary-color);
            transition: transform 0.2s;
        }
        .account-card:hover { transform: translateY(-3px); }
        .acc-name { font-size: 0.85rem; color: var(--text-muted); font-weight: 700; display: flex; justify-content: space-between; }
        .acc-balance { font-size: 1.4rem; font-weight: 800; color: var(--text-main); margin-top: 5px; }
        
        .acc-ctbc { border-left-color: #009E96; }
        .acc-cathay { border-left-color: #26A600; }
        .acc-taishin { border-left-color: #E60012; }
        .acc-cash { border-left-color: #D4A373; }

        /* --- Input Form (Left Column) --- */
        .widget-input {
            grid-column: span 4;
            grid-row: span 2;
        }
        
        .type-tabs {
            display: flex;
            background: #F4F1EE;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
        }
        .tab-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 700;
            color: var(--text-muted);
            transition: 0.2s;
        }
        .tab-btn.active { background: #FFF; color: var(--text-main); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-btn[data-type="expense"].active { color: var(--danger-color); }
        .tab-btn[data-type="income"].active { color: var(--success-color); }
        .tab-btn[data-type="transfer"].active { color: var(--transfer-color); }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 5px; font-weight: 700; }
        
        .input-field {
            width: 100%; padding: 12px; border: 2px solid #F0EAE6; border-radius: 12px;
            font-size: 1rem; background: #FAFAFA; color: var(--text-main); outline: none; transition: 0.2s;
        }
        .input-field:focus { border-color: var(--primary-color); background: #FFF; }
        select.input-field { appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23C59D7F%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; }

        .btn-submit {
            width: 100%; padding: 14px; margin-top: auto;
            background: var(--primary-color); color: white; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 800; cursor: pointer; transition: 0.2s;
        }
        .btn-submit:hover { background: var(--primary-dark); transform: translateY(-2px); }

        /* --- List (Right Column) --- */
        .widget-list {
            grid-column: span 8;
            grid-row: span 2;
            max-height: 550px;
        }
        .list-header-controls {
            display: flex;
            gap: 10px;
        }
        .search-input {
            padding: 6px 12px;
            border-radius: 20px;
            border: 2px solid #F0EAE6;
            outline: none;
            font-size: 0.85rem;
            width: 150px;
            transition: width 0.3s;
        }
        .search-input:focus {
            width: 200px;
            border-color: var(--primary-color);
        }

        .list-container { overflow-y: auto; flex: 1; padding-right: 5px; }

        .transaction-item {
            display: flex; align-items: center; justify-content: space-between;
            background: #F9F9F9; padding: 12px 15px; border-radius: 12px;
            margin-bottom: 10px; border-left: 4px solid transparent;
            transition: 0.2s;
        }
        .transaction-item:hover { background: #FFF; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        .t-left { display: flex; align-items: center; gap: 12px; }
        .t-icon { width: 40px; height: 40px; border-radius: 50%; background: #EEE; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .t-details { display: flex; flex-direction: column; }
        .t-title { font-weight: 700; color: var(--text-main); font-size: 0.95rem; }
        .t-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 8px; }
        .meta-tag { background: #F0EAE6; padding: 1px 6px; border-radius: 4px; }
        
        .t-amount { font-weight: 800; font-size: 1rem; margin-right: 10px; }
        .btn-del { border: none; background: none; color: #DDD; font-size: 1.2rem; cursor: pointer; }
        .btn-del:hover { color: var(--danger-color); }

        .type-expense .t-icon { background: #FFE5E5; color: var(--danger-color); }
        .type-expense .t-amount { color: var(--danger-color); }
        .type-expense { border-left-color: var(--danger-color); }
        .type-income .t-icon { background: #E5F5E5; color: var(--success-color); }
        .type-income .t-amount { color: var(--success-color); }
        .type-income { border-left-color: var(--success-color); }
        .type-transfer .t-icon { background: #E5EAF5; color: var(--transfer-color); }
        .type-transfer .t-amount { color: var(--text-main); }
        .type-transfer { border-left-color: var(--transfer-color); }

        /* --- Chart Widget (Improved) --- */
        .widget-chart {
            grid-column: span 12;
            min-height: 400px;
        }
        
        /* Chart Controls */
        .chart-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .chart-filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .chart-select {
            padding: 8px 12px;
            border-radius: 10px;
            border: 2px solid #F0EAE6;
            background: white;
            color: var(--text-main);
            font-size: 0.9rem;
            cursor: pointer;
            outline: none;
        }
        .chart-select:focus { border-color: var(--primary-color); }

        .chart-toggle {
            display: flex;
            background: #F4F1EE;
            border-radius: 10px;
            padding: 3px;
        }
        .toggle-btn {
            border: none;
            background: transparent;
            padding: 6px 12px;
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .toggle-btn.active {
            background: white;
            color: var(--primary-dark);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .charts-container {
            display: flex; 
            width: 100%; 
            gap: 30px; 
            justify-content: space-between; 
            flex-wrap: wrap;
            flex: 1;
        }
        .chart-box { 
            flex: 1; 
            min-width: 350px; 
            background: #FAFAFA;
            border-radius: 16px;
            padding: 15px;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .chart-box h4 {
            text-align: center;
            margin-bottom: 15px;
            color: var(--text-main);
            font-size: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .canvas-wrapper {
            flex: 1;
            position: relative;
            min-height: 250px;
        }

        /* --- Toast Notification --- */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
            min-width: 250px;
            border-left: 5px solid var(--primary-color);
        }
        .toast.success { border-left-color: var(--success-color); }
        .toast.error { border-left-color: var(--danger-color); }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .dashboard-grid { display: flex; flex-direction: column; }
            .accounts-row { grid-template-columns: 1fr 1fr; }
            .chart-box { width: 100%; min-width: 100%; }
            .chart-toolbar { flex-direction: column; align-items: flex-start; }
            header { flex-direction: column; align-items: flex-start; }
            .header-subtitle { margin-left: 0; }
            .header-actions { width: 100%; flex-wrap: wrap; }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-title">
                <h1>ğŸ§‹ Milk Tea Finance</h1>
                <div class="header-subtitle">å¤šå¸³æˆ¶è¨˜å¸³ | ç°¡å–®ç†è²¡</div>
            </div>
            
            <div class="header-actions">
                <!-- Backup Actions -->
                <button class="btn-sm" onclick="exportData()" title="åŒ¯å‡ºç´€éŒ„">ğŸ“¥ åŒ¯å‡º</button>
                <button class="btn-sm" onclick="document.getElementById('importFile').click()" title="åŒ¯å…¥ç´€éŒ„">ğŸ“¤ åŒ¯å…¥</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(this)" accept=".json">
                
                <!-- Reset & Date -->
                <button class="btn-sm" onclick="loadTestData()" title="è¼‰å…¥é è¨­è³‡æ–™">ğŸ”„ æ¸¬è©¦æ•¸æ“š</button>
                <div style="font-weight: 800; color: var(--primary-dark); font-size: 1.1rem; margin-left: 10px;" id="currentDate">Loading...</div>
            </div>
        </header>

        <div class="dashboard-grid">
            
            <!-- Account Balances -->
            <div class="accounts-row">
                <div class="account-card acc-ctbc">
                    <div class="acc-name">ä¸­åœ‹ä¿¡è¨— <span>ğŸ¦</span></div>
                    <div class="acc-balance" id="bal-ctbc">$0</div>
                </div>
                <div class="account-card acc-cathay">
                    <div class="acc-name">åœ‹æ³°ä¸–è¯ <span>ğŸŒ³</span></div>
                    <div class="acc-balance" id="bal-cathay">$0</div>
                </div>
                <div class="account-card acc-taishin">
                    <div class="acc-name">å°æ–°éŠ€è¡Œ <span>ğŸ¶</span></div>
                    <div class="acc-balance" id="bal-taishin">$0</div>
                </div>
                <div class="account-card acc-cash">
                    <div class="acc-name">ç¾é‡‘éŒ¢åŒ… <span>ğŸ‘›</span></div>
                    <div class="acc-balance" id="bal-cash">$0</div>
                </div>
            </div>

            <!-- Input Form -->
            <div class="widget widget-input">
                <div class="widget-title">âœï¸ æ–°å¢ç´€éŒ„</div>
                
                <div class="type-tabs">
                    <button class="tab-btn active" onclick="setTxType('expense')" data-type="expense">æ”¯å‡º</button>
                    <button class="tab-btn" onclick="setTxType('income')" data-type="income">æ”¶å…¥</button>
                    <button class="tab-btn" onclick="setTxType('transfer')" data-type="transfer">è½‰å¸³</button>
                </div>

                <form id="txForm">
                    <div class="form-group">
                        <label class="form-label">æ—¥æœŸ</label>
                        <input type="date" id="date" class="input-field" required>
                    </div>

                    <div class="form-group" id="grp-category">
                        <label class="form-label">åˆ†é¡</label>
                        <select id="category" class="input-field"></select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">é …ç›®åç¨± / å‚™è¨»</label>
                        <input type="text" id="desc" class="input-field" placeholder="ä¾‹å¦‚ï¼šåˆé¤ã€è–ªæ°´..." required>
                    </div>

                    <!-- Single Account -->
                    <div class="form-group" id="grp-account">
                        <label class="form-label" id="lbl-account">æ”¯å‡ºå¸³æˆ¶</label>
                        <select id="account" class="input-field">
                            <option value="cash">ç¾é‡‘</option>
                            <option value="ctbc">ä¸­åœ‹ä¿¡è¨—</option>
                            <option value="cathay">åœ‹æ³°ä¸–è¯</option>
                            <option value="taishin">å°æ–°éŠ€è¡Œ</option>
                        </select>
                    </div>

                    <!-- Transfer Accounts -->
                    <div class="form-group" id="grp-transfer" style="display:none;">
                        <label class="form-label">è½‰å‡ºå¸³æˆ¶ (From)</label>
                        <select id="fromAccount" class="input-field">
                            <option value="ctbc">ä¸­åœ‹ä¿¡è¨—</option>
                            <option value="cathay">åœ‹æ³°ä¸–è¯</option>
                            <option value="taishin">å°æ–°éŠ€è¡Œ</option>
                            <option value="cash">ç¾é‡‘</option>
                        </select>
                        <div style="text-align:center; font-size:1.2rem; color:var(--text-muted); margin: 5px 0;">â†“</div>
                        <label class="form-label">è½‰å…¥å¸³æˆ¶ (To)</label>
                        <select id="toAccount" class="input-field">
                            <option value="cash">ç¾é‡‘</option>
                            <option value="ctbc">ä¸­åœ‹ä¿¡è¨—</option>
                            <option value="cathay">åœ‹æ³°ä¸–è¯</option>
                            <option value="taishin">å°æ–°éŠ€è¡Œ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">é‡‘é¡</label>
                        <input type="number" id="amount" class="input-field" placeholder="0" min="1" required>
                    </div>

                    <button type="submit" class="btn-submit">ç¢ºèªæ–°å¢</button>
                </form>
            </div>

            <!-- Transaction List -->
            <div class="widget widget-list">
                <div class="widget-title">
                    ğŸ§¾ è¿‘æœŸç´€éŒ„
                    <div class="list-header-controls">
                        <input type="text" id="search" class="search-input" placeholder="ğŸ” æœå°‹ç´€éŒ„..." onkeyup="renderList()">
                    </div>
                </div>
                <div class="list-container" id="txList"></div>
                <div id="emptyState" style="text-align:center; padding:40px; color:var(--text-muted); display:none;">
                    <div style="font-size:3rem;">ğŸƒ</div>
                    <p>æš«ç„¡ç´€éŒ„</p>
                </div>
            </div>

            <!-- Charts -->
            <div class="widget widget-chart">
                <div class="widget-title">ğŸ“Š è²¡å‹™åˆ†æ</div>
                
                <div class="chart-toolbar">
                    <!-- Date Filter -->
                    <div class="chart-filter-group">
                        <span style="font-weight:700; color:var(--text-muted); font-size:0.9rem;">ğŸ“… æœˆä»½ï¼š</span>
                        <select id="chartMonth" class="chart-select" onchange="renderCharts()">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>

                <div class="charts-container">
                    <!-- Left: Expense Analysis -->
                    <div class="chart-box">
                        <h4>
                            æ”¯å‡ºåˆ†æ
                            <div class="chart-toggle">
                                <button class="toggle-btn active" onclick="switchLeftChart('doughnut', this)">åœ“é¤…</button>
                                <button class="toggle-btn" onclick="switchLeftChart('bar', this)">é•·æ¢</button>
                            </div>
                        </h4>
                        <div class="canvas-wrapper">
                            <canvas id="leftChart"></canvas>
                        </div>
                    </div>

                    <!-- Right: Trend/Asset -->
                    <div class="chart-box">
                        <h4>
                            è³‡ç”¢èˆ‡è¶¨å‹¢
                            <div class="chart-toggle">
                                <button class="toggle-btn active" onclick="switchRightChart('doughnut', this)">è³‡ç”¢</button>
                                <button class="toggle-btn" onclick="switchRightChart('line', this)">è¶¨å‹¢</button>
                            </div>
                        </h4>
                        <div class="canvas-wrapper">
                            <canvas id="rightChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        // --- 1. Data & Config ---
        const ACCOUNTS = { ctbc: 'ä¸­åœ‹ä¿¡è¨—', cathay: 'åœ‹æ³°ä¸–è¯', taishin: 'å°æ–°éŠ€è¡Œ', cash: 'ç¾é‡‘' };
        
        const EXPENSE_CATS = [
            {id: 'food', name: 'é¤é£²', icon: 'ğŸ±'},
            {id: 'transport', name: 'äº¤é€š', icon: 'ğŸš‡'},
            {id: 'shopping', name: 'è³¼ç‰©', icon: 'ğŸ›ï¸'},
            {id: 'entertainment', name: 'å¨›æ¨‚', icon: 'ğŸ®'},
            {id: 'bills', name: 'å¸³å–®', icon: 'ğŸ§¾'},
            {id: 'learning', name: 'å­¸ç¿’', icon: 'ğŸ“š'},
            {id: 'other', name: 'å…¶ä»–', icon: 'ğŸ“¦'}
        ];

        const INCOME_CATS = [
            {id: 'salary', name: 'è–ªæ°´', icon: 'ğŸ’°'},
            {id: 'bonus', name: 'çé‡‘', icon: 'ğŸ’'},
            {id: 'investment', name: 'æŠ•è³‡', icon: 'ğŸ“ˆ'},
            {id: 'other', name: 'å…¶ä»–', icon: 'ğŸ“¦'}
        ];

        // --- 2. Color Palette (Milk Tea Theme) ---
        const CHART_COLORS = [
            '#A3B18A', // Matcha Green
            '#D4A373', // Milk Tea
            '#E76F51', // Muted Red/Rose
            '#2A9D8F', // Teal
            '#E9C46A', // Pudding Yellow
            '#8D99AE', // Blueberry/Grey
            '#F4A261', // Orange
            '#6D597A', // Taro Purple
            '#3D405B'  // Dark Navy
        ];

        // --- 3. State ---
        let transactions = JSON.parse(localStorage.getItem('milk_tea_v3_txs'));
        if (!transactions || transactions.length === 0) {
            // Default init with specific user data
             const today = new Date().toISOString().split('T')[0];
             transactions = [
                { id: 1, date: today, desc: 'åˆå§‹é¤˜é¡', amount: 3440, type: 'income', account: 'ctbc', category: 'å…¶ä»–', icon: 'ğŸ“¦' },
                { id: 2, date: today, desc: 'åˆå§‹é¤˜é¡', amount: 60959, type: 'income', account: 'cathay', category: 'å…¶ä»–', icon: 'ğŸ“¦' },
                { id: 3, date: today, desc: 'åˆå§‹é¤˜é¡', amount: 21700, type: 'income', account: 'taishin', category: 'å…¶ä»–', icon: 'ğŸ“¦' },
                { id: 4, date: today, desc: 'åˆå§‹é¤˜é¡', amount: 4962, type: 'income', account: 'cash', category: 'å…¶ä»–', icon: 'ğŸ“¦' },
            ];
            localStorage.setItem('milk_tea_v3_txs', JSON.stringify(transactions));
        }

        let currentType = 'expense';
        let leftChartInstance = null;
        let rightChartInstance = null;
        let leftChartType = 'doughnut';
        let rightChartType = 'doughnut';

        // --- 4. Initialization ---
        const dateInput = document.getElementById('date');
        dateInput.value = new Date().toISOString().split('T')[0];
        document.getElementById('currentDate').innerText = new Date().toLocaleDateString();

        // Populate Category Dropdown
        const categorySelect = document.getElementById('category');
        function updateCategoryOptions() {
            categorySelect.innerHTML = '';
            const list = currentType === 'income' ? INCOME_CATS : EXPENSE_CATS;
            list.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.name; 
                opt.innerText = `${c.icon} ${c.name}`;
                categorySelect.appendChild(opt);
            });
        }
        updateCategoryOptions();

        // Populate Month Filter
        const monthSelect = document.getElementById('chartMonth');
        function initMonthSelect() {
            const today = new Date();
            for (let i = 0; i < 6; i++) { // Last 6 months
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const value = d.toISOString().slice(0, 7); // YYYY-MM
                const text = `${d.getFullYear()}å¹´ ${d.getMonth() + 1}æœˆ`;
                const opt = document.createElement('option');
                opt.value = value;
                opt.innerText = text;
                monthSelect.appendChild(opt);
            }
        }
        initMonthSelect();

        // Initial Render
        renderUI();

        // --- 5. Core Functions ---

        // Switch Transaction Type (Income/Expense/Transfer)
        function setTxType(type) {
            currentType = type;
            document.querySelectorAll('.type-tabs .tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.type === type));
            
            const grpCat = document.getElementById('grp-category');
            const grpAcc = document.getElementById('grp-account');
            const grpTrans = document.getElementById('grp-transfer');
            const lblAcc = document.getElementById('lbl-account');

            if (type === 'transfer') {
                grpCat.style.display = 'none';
                grpAcc.style.display = 'none';
                grpTrans.style.display = 'block';
            } else {
                grpCat.style.display = 'block';
                grpAcc.style.display = 'block';
                grpTrans.style.display = 'none';
                lblAcc.innerText = type === 'income' ? 'å­˜å…¥å¸³æˆ¶' : 'æ”¯å‡ºå¸³æˆ¶';
                updateCategoryOptions();
            }
        }

        // Form Submit
        document.getElementById('txForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = parseInt(document.getElementById('amount').value);
            if (!amount || amount <= 0) return;

            const tx = {
                id: Date.now(),
                date: dateInput.value,
                desc: document.getElementById('desc').value,
                amount: amount,
                type: currentType
            };

            if (currentType === 'transfer') {
                tx.fromAccount = document.getElementById('fromAccount').value;
                tx.toAccount = document.getElementById('toAccount').value;
                tx.category = 'è½‰å¸³';
                tx.icon = 'ğŸ”„';
                if(tx.fromAccount === tx.toAccount) return showToast('è½‰å‡ºèˆ‡è½‰å…¥å¸³æˆ¶ä¸èƒ½ç›¸åŒ', 'error');
            } else {
                tx.account = document.getElementById('account').value;
                tx.category = categorySelect.value;
                const list = currentType === 'income' ? INCOME_CATS : EXPENSE_CATS;
                tx.icon = (list.find(c => c.name === tx.category) || {}).icon || 'âšª';
            }

            transactions.unshift(tx);
            saveData();
            renderUI();
            
            showToast('æ–°å¢æˆåŠŸï¼', 'success');
            
            // Reset fields
            document.getElementById('desc').value = '';
            document.getElementById('amount').value = '';
        });

        function deleteTx(id) {
            if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                renderUI();
                showToast('å·²åˆªé™¤ç´€éŒ„', 'success');
            }
        }

        function saveData() { localStorage.setItem('milk_tea_v3_txs', JSON.stringify(transactions)); }

        // --- 6. Render Logic ---

        function renderUI() {
            const balances = calculateBalances();
            renderList();
            renderCharts(balances);
        }

        function calculateBalances() {
            let bals = { ctbc: 0, cathay: 0, taishin: 0, cash: 0 };
            transactions.slice().reverse().forEach(tx => {
                if (tx.type === 'income') bals[tx.account] += tx.amount;
                else if (tx.type === 'expense') bals[tx.account] -= tx.amount;
                else if (tx.type === 'transfer') {
                    bals[tx.fromAccount] -= tx.amount;
                    bals[tx.toAccount] += tx.amount;
                }
            });
            for (const [k, v] of Object.entries(bals)) {
                const el = document.getElementById(`bal-${k}`);
                if(el) el.innerText = `$${v.toLocaleString()}`;
            }
            return bals;
        }

        function renderList() {
            const listEl = document.getElementById('txList');
            const searchVal = document.getElementById('search').value.toLowerCase();
            
            listEl.innerHTML = '';
            
            // Filter by search
            const filtered = transactions.filter(t => 
                t.desc.toLowerCase().includes(searchVal) || 
                t.category.toLowerCase().includes(searchVal) ||
                (ACCOUNTS[t.account] && ACCOUNTS[t.account].includes(searchVal))
            );

            if (filtered.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            document.getElementById('emptyState').style.display = 'none';

            filtered.slice(0, 50).forEach(tx => {
                const div = document.createElement('div');
                div.className = `transaction-item type-${tx.type}`;
                
                let info = '', amt = '';
                if(tx.type === 'transfer') {
                    amt = `$${tx.amount.toLocaleString()}`;
                    info = `${ACCOUNTS[tx.fromAccount]} â†’ ${ACCOUNTS[tx.toAccount]}`;
                } else {
                    amt = `${tx.type==='income'?'+':'-'}$${tx.amount.toLocaleString()}`;
                    info = `${ACCOUNTS[tx.account]} Â· ${tx.category}`;
                }

                div.innerHTML = `
                    <div class="t-left">
                        <div class="t-icon">${tx.icon}</div>
                        <div class="t-details">
                            <div class="t-title">${tx.desc}</div>
                            <div class="t-meta">${tx.date} <span class="meta-tag">${info}</span></div>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;">
                        <span class="t-amount">${amt}</span>
                        <button class="btn-del" onclick="deleteTx(${tx.id})">Ã—</button>
                    </div>
                `;
                listEl.appendChild(div);
            });
        }

        // --- 7. Chart Logic (Optimized) ---

        function switchLeftChart(type, btn) {
            leftChartType = type;
            btn.parentNode.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderCharts();
        }

        function switchRightChart(type, btn) {
            rightChartType = type;
            btn.parentNode.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderCharts();
        }

        function renderCharts(balances = null) {
            if(!balances) balances = calculateBalances();
            const selectedMonth = monthSelect.value; // YYYY-MM

            // --- Left Chart: Expenses (Category) ---
            const expTxs = transactions.filter(t => t.type === 'expense' && t.date.startsWith(selectedMonth));
            const catMap = {};
            expTxs.forEach(t => { catMap[t.category] = (catMap[t.category] || 0) + t.amount; });
            
            // Sort by amount desc
            const sortedCats = Object.entries(catMap).sort((a,b) => b[1] - a[1]);
            const labels = sortedCats.map(x => x[0]);
            const data = sortedCats.map(x => x[1]);

            const leftCtx = document.getElementById('leftChart').getContext('2d');
            if(leftChartInstance) leftChartInstance.destroy();

            leftChartInstance = new Chart(leftCtx, {
                type: leftChartType, // 'doughnut' or 'bar'
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ”¯å‡ºé‡‘é¡',
                        data: data,
                        backgroundColor: CHART_COLORS,
                        borderRadius: 8, // Soft edges
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: leftChartType === 'doughnut',
                            position: 'bottom',
                            labels: { padding: 20, usePointStyle: true }
                        }
                    },
                    scales: {
                        x: { display: leftChartType === 'bar', grid: {display:false} },
                        y: { display: leftChartType === 'bar', grid: {color: '#F0EAE6'} }
                    }
                }
            });

            // --- Right Chart: Assets OR Trend ---
            const rightCtx = document.getElementById('rightChart').getContext('2d');
            if(rightChartInstance) rightChartInstance.destroy();

            if (rightChartType === 'doughnut') {
                // Asset Distribution
                const accData = [balances.ctbc, balances.cathay, balances.taishin, balances.cash].map(v => Math.max(0,v));
                rightChartInstance = new Chart(rightCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['ä¸­ä¿¡', 'åœ‹æ³°', 'å°æ–°', 'ç¾é‡‘'],
                        datasets: [{
                            data: accData,
                            backgroundColor: ['#009E96', '#26A600', '#E60012', '#D4A373'],
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } }
                        },
                        cutout: '60%'
                    }
                });
            } else {
                // Daily Spending Trend (Line)
                const daysInMonth = new Date(selectedMonth.split('-')[0], selectedMonth.split('-')[1], 0).getDate();
                const dailyMap = new Array(daysInMonth).fill(0);
                
                expTxs.forEach(t => {
                    const day = parseInt(t.date.split('-')[2]) - 1;
                    if(day >= 0 && day < daysInMonth) dailyMap[day] += t.amount;
                });

                rightChartInstance = new Chart(rightCtx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: daysInMonth}, (_, i) => i + 1),
                        datasets: [{
                            label: 'æ¯æ—¥æ”¯å‡º',
                            data: dailyMap,
                            borderColor: '#C59D7F',
                            backgroundColor: 'rgba(197, 157, 127, 0.2)',
                            fill: true,
                            tension: 0.4, // Smooth curve
                            pointRadius: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: {display:false} },
                            y: { grid: {color: '#F0EAE6'}, beginAtZero: true }
                        },
                        interaction: { intersect: false, mode: 'index' }
                    }
                });
            }
        }

        // --- 8. System Utilities ---

        function showToast(msg, type = 'normal') {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            div.className = `toast ${type}`;
            div.innerHTML = `<span>${type==='success'?'âœ…':type==='error'?'âš ï¸':'ğŸ’¬'}</span> ${msg}`;
            container.appendChild(div);
            setTimeout(() => {
                div.style.opacity = '0';
                div.style.transform = 'translateX(100%)';
                setTimeout(() => div.remove(), 300);
            }, 3000);
        }

        function exportData() {
            const dataStr = JSON.stringify(transactions, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `milktea_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            showToast('è³‡æ–™å·²åŒ¯å‡ºï¼è«‹å¦¥å–„ä¿å­˜', 'success');
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if(Array.isArray(imported)) {
                        if(confirm(`ç¢ºå®šåŒ¯å…¥ ${imported.length} ç­†è³‡æ–™ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰ç´€éŒ„ã€‚`)) {
                            transactions = imported;
                            saveData();
                            renderUI();
                            showToast('è³‡æ–™é‚„åŸæˆåŠŸï¼', 'success');
                        }
                    } else {
                        showToast('æª”æ¡ˆæ ¼å¼éŒ¯èª¤', 'error');
                    }
                } catch(err) {
                    showToast('ç„¡æ•ˆçš„ JSON æª”æ¡ˆ', 'error');
                }
                input.value = ''; // reset
            };
            reader.readAsText(file);
        }

        function loadTestData() {
            if(confirm('è¼‰å…¥æ¸¬è©¦æ•¸æ“šï¼Ÿ(é€™æœƒæ¸…é™¤ç¾æœ‰è³‡æ–™ä¸¦å¡«å…¥é è¨­é¤˜é¡)')) {
                const today = new Date().toISOString().split('T')[0];
                const demo = [
                    { id: 1, date: today, desc: 'åˆå§‹é¤˜é¡', amount: 3440, type: 'income', account: 'ctbc', category: 'å…¶ä»–', icon: 'ğŸ“¦' },
                    { id: 2, date: today, desc: 'åˆå§‹é¤˜é¡', amount: 60959, type: 'income', account: 'cathay', category: 'å…¶ä»–', icon: 'ğŸ“¦' },
                    { id: 3, date: today, desc: 'åˆå§‹é¤˜é¡', amount: 21700, type: 'income', account: 'taishin', category: 'å…¶ä»–', icon: 'ğŸ“¦' },
                    { id: 4, date: today, desc: 'åˆå§‹é¤˜é¡', amount: 4962, type: 'income', account: 'cash', category: 'å…¶ä»–', icon: 'ğŸ“¦' },
                ];
                transactions = demo;
                saveData();
                location.reload();
            }
        }

    </script>
</body>
</html>
