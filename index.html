<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milk Tea Finance v7.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Ê†∏ÂøÉËÆäÊï∏ --- */
        :root {
            --bg-color: #F7F5F2;
            --card-bg: #FFFFFF;
            --primary-color: #C59D7F;
            --primary-dark: #8D7B68;
            --text-main: #4A403A;
            --text-muted: #9C8E83;
            --success-color: #A3B18A;
            --danger-color: #D58989;
            --transfer-color: #8D99AE;
            
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
            --shadow-soft: 0 10px 40px -10px rgba(197, 157, 127, 0.15);
            --shadow-hover: 0 20px 50px -12px rgba(197, 157, 127, 0.25);
            
            --grid-row-height: 60px;
            --grid-gap: 20px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Nunito', 'Noto Sans TC', sans-serif; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
            background-image: radial-gradient(var(--primary-color) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* --- Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(12px);
            padding: 15px 30px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(197, 157, 127, 0.08);
            flex-wrap: wrap;
            gap: 15px;
            border: 1px solid rgba(255,255,255,0.8);
        }
        
        .header-left h1 {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary-dark);
            letter-spacing: -0.5px;
            margin: 0;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .datetime-display {
            font-family: 'Nunito', 'Noto Sans TC', monospace;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary-dark);
            background: linear-gradient(135deg, #FFF 0%, #F9F9F9 100%);
            padding: 8px 20px;
            border-radius: 50px;
            border: 1px solid #EAEAEA;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.02), 0 2px 10px rgba(197, 157, 127, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: 0.5px;
        }
        .datetime-display::before { content: 'üïí'; font-size: 1.1rem; }

        .btn-icon {
            width: 40px; height: 40px;
            border-radius: 12px;
            border: 1px solid #F0EAE6;
            background: white;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .btn-icon:hover { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        .btn-reset {
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid var(--primary-color);
            background: white;
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 700;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .btn-reset:hover { background: var(--primary-color); color: white; }

        /* --- Grid System --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-auto-rows: var(--grid-row-height);
            gap: var(--grid-gap);
            position: relative;
        }

        .widget {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            transition: box-shadow 0.2s, transform 0.2s;
            border: 1px solid rgba(255,255,255,0.5);
        }
        
        .widget:hover { box-shadow: var(--shadow-hover); z-index: 10; }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            cursor: grab;
            padding-bottom: 8px;
            border-bottom: 2px solid #F8F6F4;
            flex-shrink: 0;
        }
        .widget-header:active { cursor: grabbing; }

        .widget-title {
            font-weight: 800;
            color: var(--primary-dark);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            pointer-events: none;
        }
        
        .drag-handle { color: var(--text-muted); opacity: 0.5; font-size: 1.2rem; margin-right: 10px; }

        .resize-handle {
            position: absolute;
            bottom: 0; right: 0; width: 20px; height: 20px;
            cursor: nwse-resize;
            background: linear-gradient(135deg, transparent 50%, var(--primary-color) 50%);
            opacity: 0; transition: opacity 0.2s;
            border-bottom-right-radius: var(--radius-lg);
            z-index: 20;
        }
        .widget:hover .resize-handle { opacity: 0.8; }

        /* --- Accounts Widget --- */
        .accounts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 100%;
            overflow-y: auto;
            padding: 5px;
            align-content: start;
        }
        @media (min-width: 900px) { .accounts-container { grid-template-columns: repeat(4, 1fr); } }

        .acc-card {
            background: #FAFAFA; padding: 20px; border-radius: 20px; border-left: 6px solid #CCC;
            display: flex; flex-direction: column; justify-content: space-between;
            transition: all 0.2s; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.03); min-height: 100px;
        }
        .acc-card:hover { transform: translateY(-3px); background: #FFF; box-shadow: 0 8px 20px rgba(197, 157, 127, 0.15); }
        .acc-ctbc { border-left-color: #009E96; }
        .acc-cathay { border-left-color: #26A600; }
        .acc-taishin { border-left-color: #E60012; }
        .acc-cash { border-left-color: #D4A373; }
        
        .acc-total { 
            border-left: none;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            cursor: default; color: white; grid-column: 1 / -1; margin-bottom: 5px;
        }
        .acc-total:hover { transform: none; box-shadow: 0 4px 15px rgba(197, 157, 127, 0.3); background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)) !important; }
        .acc-total .acc-label, .acc-total .acc-val { color: white !important; }
        .acc-total .acc-val::after { content: none !important; }

        .acc-val { font-size: 1.5rem; font-weight: 800; color: var(--text-main); margin-top: 10px; position: relative; }
        .acc-card:not(.acc-total):hover .acc-val::after { content: '‚úé'; position: absolute; right: 0; font-size: 0.9rem; color: var(--primary-color); }
        .acc-label { font-size: 0.9rem; color: var(--text-muted); font-weight: 700; display: flex; justify-content: space-between; align-items: center; }

        /* --- Input Widget --- */
        .input-scroll-area { overflow-y: auto; flex: 1; padding-right: 5px; display: flex; flex-direction: column; justify-content: flex-start; }
        .type-tabs { display: flex; background: #F4F1EE; border-radius: 10px; padding: 3px; margin-bottom: 10px; flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 6px; border: none; background: transparent; cursor: pointer; border-radius: 8px; color: var(--text-muted); font-weight: 700; transition:0.2s; font-size: 0.9rem; }
        .tab-btn.active { background: #FFF; color: var(--text-main); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-btn[data-type="expense"].active { color: var(--danger-color); }
        .tab-btn[data-type="income"].active { color: var(--success-color); }
        
        .input-group { margin-bottom: 8px; }
        .input-label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 3px; font-weight: 700; }
        .form-control { width: 100%; padding: 8px 10px; border: 2px solid #F0EAE6; border-radius: 10px; outline: none; background: #FAFAFA; font-size: 0.95rem; height: 38px; }
        .form-control:focus { border-color: var(--primary-color); background: #FFF; }
        
        .btn-submit { width: 100%; padding: 10px; background: var(--primary-color); color: white; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; margin-top: auto; font-size: 1rem; transition: 0.2s; }
        .btn-submit:hover { background: var(--primary-dark); transform: translateY(-1px); }

        /* --- List Widget --- */
        .list-controls { margin-bottom: 10px; }
        .search-input { width: 100%; padding: 8px 15px; border-radius: 20px; border: 2px solid #F0EAE6; outline:none; }
        .tx-list { overflow-y: auto; flex: 1; padding-right: 5px; }
        .tx-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #FAFAFA; border-radius: 12px; margin-bottom: 6px; transition: 0.2s; border-left: 4px solid transparent; }
        .tx-item:hover { background: #FFF; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .type-expense { border-left-color: var(--danger-color); }
        .type-income { border-left-color: var(--success-color); }
        .type-transfer { border-left-color: var(--transfer-color); }
        .tx-info h4 { font-size: 0.9rem; color: var(--text-main); margin-bottom: 2px; }
        .tx-info p { font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px; }
        .tx-badge { background: #EAEAEA; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
        .tx-amt { font-weight: 800; font-size: 0.95rem; }
        .tx-amt.neg { color: var(--danger-color); }
        .tx-amt.pos { color: var(--success-color); }

        /* --- Chart Widget --- */
        .chart-wrapper { position: relative; width: 100%; height: 100%; min-height: 250px; }

        /* --- Modals (General & Settings) --- */
        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(4px);
            display: none; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; transition: opacity 0.3s;
        }
        .custom-modal-overlay.active { display: flex; opacity: 1; }
        
        .custom-modal {
            background: white; width: 90%; max-width: 400px;
            border-radius: 20px; padding: 25px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            transform: scale(0.9); transition: transform 0.3s;
            display: flex; flex-direction: column;
        }
        /* Settings Modal specific */
        .custom-modal.settings-modal { max-width: 700px; height: 80vh; padding: 0; }
        
        .custom-modal-overlay.active .custom-modal { transform: scale(1); }
        .modal-title { font-size: 1.2rem; font-weight: 800; color: var(--primary-dark); margin-bottom: 15px; }
        .modal-body { margin-bottom: 20px; color: var(--text-main); font-size: 0.95rem; }
        .modal-input { width: 100%; padding: 12px; border: 2px solid #F0EAE6; border-radius: 12px; font-size: 1.1rem; outline: none; margin-top: 10px; }
        .modal-input:focus { border-color: var(--primary-color); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: auto; }
        .modal-btn { padding: 10px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; }
        .modal-btn-cancel { background: #F4F1EE; color: var(--text-muted); }
        .modal-btn-confirm { background: var(--primary-color); color: white; }

        /* Settings Modal Styles */
        .settings-header { padding: 20px; border-bottom: 1px solid #F0F0F0; display: flex; justify-content: space-between; align-items: center; }
        .settings-content { flex: 1; display: flex; overflow: hidden; }
        .settings-col { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .settings-col:first-child { border-right: 1px solid #F0F0F0; background: #FAFAFA; flex: 0 0 200px; }
        .settings-list { list-style: none; padding: 0; }
        .settings-item { 
            padding: 10px 15px; border-radius: 10px; cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem;
        }
        .settings-item:hover { background: #F4F1EE; }
        .settings-item.active { background: white; color: var(--primary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .settings-item .btn-del-cat { opacity: 0; color: #CCC; cursor: pointer; font-size: 1.1rem; padding: 2px 6px; }
        .settings-item:hover .btn-del-cat { opacity: 1; }
        .settings-item .btn-del-cat:hover { color: var(--danger-color); }
        .settings-add { margin-top: 10px; display: flex; gap: 5px; }
        .settings-add input { flex: 1; padding: 8px; border: 1px solid #E0E0E0; border-radius: 8px; font-size: 0.9rem; }
        .settings-add button { padding: 8px 12px; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; }

        @media (max-width: 768px) {
            .dashboard-grid { display: flex; flex-direction: column; height: auto; }
            .widget { height: auto !important; min-height: 300px; }
            .resize-handle { display: none; }
            header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .header-right { width: 100%; justify-content: space-between; }
            .datetime-display { flex: 1; justify-content: center; }
            .settings-content { flex-direction: column; }
            .settings-col:first-child { border-right: none; border-bottom: 1px solid #F0F0F0; flex: 0 0 150px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-left">
            <h1>Milk Tea Finance</h1>
        </div>
        <div class="header-right">
            <div class="datetime-display" id="datetime">Loading...</div>
            <button class="btn-icon" onclick="openSettings()" title="Ë®≠ÂÆöÂàÜÈ°ûËàáÁ¥∞È†Ö">‚öôÔ∏è</button>
            <button class="btn-reset" onclick="resetLayout()" title="Ëã•ÁâàÈù¢Ë∑ëÊéâË´ãÈªûÊ≠§">‚ü≤ ÈáçÁΩÆÁâàÈù¢</button>
        </div>
    </header>

    <div class="dashboard-grid" id="grid">
        
        <!-- Widget 1: Accounts -->
        <div class="widget" id="widget-accounts" data-id="accounts" style="grid-column: span 12; grid-row: span 5;">
            <div class="resize-handle"></div>
            <div class="widget-header">
                <div class="widget-title"><span class="drag-handle">‚ãÆ‚ãÆ</span> üí≥ Â∏≥Êà∂Á∏ΩË¶Ω</div>
                <div style="font-size:0.75rem; color:var(--text-muted);">ÈªûÊìäÂç°ÁâáÂèØ‰øÆÊ≠£È§òÈ°ç</div>
            </div>
            <div class="accounts-container" id="accounts-container">
                <!-- JS Populated -->
            </div>
        </div>

        <!-- Widget 2: Input -->
        <div class="widget" id="widget-input" data-id="input" style="grid-column: span 4; grid-row: span 8;">
            <div class="resize-handle"></div>
            <div class="widget-header">
                <div class="widget-title"><span class="drag-handle">‚ãÆ‚ãÆ</span> ‚úèÔ∏è Êñ∞Â¢ûÁ¥ÄÈåÑ</div>
            </div>
            <div class="input-scroll-area">
                <div class="type-tabs">
                    <button class="tab-btn active" onclick="setType('expense')" data-type="expense">ÊîØÂá∫</button>
                    <button class="tab-btn" onclick="setType('income')" data-type="income">Êî∂ÂÖ•</button>
                    <button class="tab-btn" onclick="setType('transfer')" data-type="transfer">ËΩâÂ∏≥</button>
                </div>
                <form id="txForm" onsubmit="addTx(event)">
                    <div class="input-group">
                        <label class="input-label">Êó•Êúü</label>
                        <input type="date" id="date" class="form-control" required>
                    </div>
                    <div class="input-group" id="grp-cat">
                        <label class="input-label">ÂàÜÈ°ûËàáÁ¥∞È†Ö</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="category" class="form-control" style="flex: 1;" onchange="updateSubCats()"></select>
                            <select id="sub-category" class="form-control" style="flex: 1;"></select>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">È†ÖÁõÆ / ÂÇôË®ª</label>
                        <input type="text" id="desc" class="form-control" placeholder="Ëº∏ÂÖ•ÂÇôË®ª..." required>
                    </div>
                    <div class="input-group" id="grp-acc">
                        <label class="input-label" id="lbl-acc">ÊîØÂá∫Â∏≥Êà∂</label>
                        <select id="account" class="form-control">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="input-group" id="grp-trans" style="display:none;">
                        <label class="input-label">ËΩâÂá∫ (From)</label>
                        <select id="fromAccount" class="form-control"></select>
                        <div style="text-align:center; margin:2px; font-size:0.8rem; color:#ccc;">‚Üì</div>
                        <label class="input-label">ËΩâÂÖ• (To)</label>
                        <select id="toAccount" class="form-control"></select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">ÈáëÈ°ç</label>
                        <input type="number" id="amount" class="form-control" placeholder="0" required min="1">
                    </div>
                    <button class="btn-submit">Á¢∫Ë™çÊñ∞Â¢û</button>
                </form>
            </div>
        </div>

        <!-- Widget 3: List -->
        <div class="widget" id="widget-list" data-id="list" style="grid-column: span 8; grid-row: span 8;">
            <div class="resize-handle"></div>
            <div class="widget-header">
                <div class="widget-title"><span class="drag-handle">‚ãÆ‚ãÆ</span> üßæ ËøëÊúü‰∫§Êòì</div>
            </div>
            <div class="list-controls">
                <input type="text" id="search" class="search-input" placeholder="üîç ÊêúÂ∞ãÁ¥ÄÈåÑ..." onkeyup="renderList()">
            </div>
            <div class="tx-list" id="txList"></div>
        </div>

        <!-- Widget 4: Chart -->
        <div class="widget" id="widget-chart" data-id="chart" style="grid-column: span 12; grid-row: span 7;">
            <div class="resize-handle"></div>
            <div class="widget-header">
                <div class="widget-title"><span class="drag-handle">‚ãÆ‚ãÆ</span> üìä Ë≤°ÂãôÂàÜÊûê (ÊîØÂá∫‰ΩîÊØî)</div>
                <select onchange="updateChartType(this.value)" style="border:1px solid #ddd; border-radius:5px; padding:2px; font-size:0.9rem;">
                    <option value="doughnut">ÂúìÈ§ÖÂúñ</option>
                    <option value="bar">Èï∑Ê¢ùÂúñ</option>
                </select>
            </div>
            <div class="chart-wrapper">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

    </div>
</div>

<!-- Standard Modal -->
<div class="custom-modal-overlay" id="modalOverlay">
    <div class="custom-modal">
        <div class="modal-title" id="modalTitle">Ê®ôÈ°å</div>
        <div class="modal-body" id="modalBody">ÂÖßÂÆπ</div>
        <div class="modal-actions">
            <button class="modal-btn modal-btn-cancel" onclick="closeModal()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-confirm" id="modalConfirmBtn">Á¢∫Ë™ç</button>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="custom-modal-overlay" id="settingsModalOverlay">
    <div class="custom-modal settings-modal">
        <div class="settings-header">
            <div class="modal-title" style="margin:0;">‚öôÔ∏è ÂàÜÈ°ûË®≠ÂÆö</div>
            <button class="modal-btn modal-btn-cancel" onclick="closeSettings()">ÈóúÈñâ</button>
        </div>
        <div style="padding: 10px 20px; border-bottom: 1px solid #F0F0F0;">
            <div class="type-tabs" style="margin:0;">
                <button class="tab-btn active" id="set-tab-expense" onclick="switchSettingsType('expense')">ÊîØÂá∫ÂàÜÈ°û</button>
                <button class="tab-btn" id="set-tab-income" onclick="switchSettingsType('income')">Êî∂ÂÖ•ÂàÜÈ°û</button>
            </div>
        </div>
        <div class="settings-content">
            <!-- Left Col: Main Categories -->
            <div class="settings-col">
                <h4 style="margin-bottom:10px; color:var(--text-muted);">‰∏ªÂàÜÈ°û</h4>
                <ul class="settings-list" id="settingsCatList"></ul>
                <div class="settings-add">
                    <input type="text" id="newCatInput" placeholder="Êñ∞Â¢û‰∏ªÂàÜÈ°û...">
                    <button onclick="addSettingsCat()">Ôºã</button>
                </div>
            </div>
            <!-- Right Col: Sub Categories -->
            <div class="settings-col">
                <h4 style="margin-bottom:10px; color:var(--text-muted); display:flex; justify-content:space-between;">
                    Á¥∞È†ÖÂàÜÈ°û <span id="selectedCatName" style="color:var(--primary-color);"></span>
                </h4>
                <ul class="settings-list" id="settingsSubList">
                    <li style="color:#CCC; text-align:center; padding:20px;">Ë´ãÂÖàÈÅ∏ÊìáÂ∑¶ÂÅ¥‰∏ªÂàÜÈ°û</li>
                </ul>
                <div class="settings-add" id="subAddGroup" style="display:none;">
                    <input type="text" id="newSubInput" placeholder="Êñ∞Â¢ûÁ¥∞È†Ö...">
                    <button onclick="addSettingsSub()">Ôºã</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. Data Config ---
    const ACCOUNT_ORDER = ['ctbc', 'cathay', 'taishin', 'cash'];
    const ACCOUNTS = { ctbc: '‰∏≠Âúã‰ø°Ë®ó', cathay: 'ÂúãÊ≥∞‰∏ñËèØ', taishin: 'Âè∞Êñ∞ÈäÄË°å', cash: 'ÁèæÈáë' };
    
    // Default Categories
    const DEFAULT_EXPENSE_CATS = {
        'È§êÈ£≤': ['Êó©È§ê', 'ÂçàÈ§ê', 'ÊôöÈ§ê', 'È£≤Êñô', 'Èõ∂È£ü', 'ÂÆµÂ§ú'],
        '‰∫§ÈÄö': ['Êç∑ÈÅã', 'ÂÖ¨Ëªä', 'Ë®àÁ®ãËªä', 'Âä†Ê≤π', 'ÂÅúËªä', '‰øùÈ§ä'],
        'Ë≥ºÁâ©': ['Êó•Áî®ÂìÅ', 'ÊúçÈ£æ', 'ÈõªÂ≠êÁî¢ÂìÅ', 'ÁæéÂ¶ù', 'ÈõúË≤®'],
        'Â®õÊ®Ç': ['ÈõªÂΩ±', 'ÈÅäÊà≤', 'ËÅöÊúÉ', 'Ë®ÇÈñ±ÊúçÂãô', 'ÊóÖË°å'],
        'Â∏≥ÂñÆ': ['ÊàøÁßü', 'ÈõªË≤ª', 'Ê∞¥Ë≤ª', 'Áì¶ÊñØ', 'ÊâãÊ©ü', 'Á∂≤Ë∑Ø'],
        'Â≠∏Áøí': ['Êõ∏Á±ç', 'Ë™≤Á®ã', 'ËÄÉË©¶', 'ÊñáÂÖ∑'],
        'ÂÖ∂‰ªñ': ['ÈÜ´ÁôÇ', '‰øùÈö™', 'ÊçêÊ¨æ', 'ÈõúÈ†Ö']
    };

    const DEFAULT_INCOME_CATS = {
        'Ëñ™Ê∞¥': ['Êú¨Ëñ™', 'ÂÖºËÅ∑'],
        'ÁçéÈáë': ['Âπ¥ÁµÇ', 'Á∏æÊïà', 'ÂàÜÁ¥Ö'],
        'ÊäïË≥á': ['ËÇ°Á•®', 'Âà©ÊÅØ', 'ËÇ°ÊÅØ'],
        'ÂÖ∂‰ªñ': ['Êî∂Á¶Æ', 'ÈÄÄÊ¨æ', 'ÈñíÁΩÆ‰∫§Êòì']
    };
    
    // --- 2. State & Storage ---
    // Load Transactions
    let transactions = JSON.parse(localStorage.getItem('mtf_v6_txs')) || [];
    
    // Load Categories (or use default)
    let categories = JSON.parse(localStorage.getItem('mtf_v7_cats')) || {
        expense: DEFAULT_EXPENSE_CATS,
        income: DEFAULT_INCOME_CATS
    };

    let currentType = 'expense';
    let chartInstance = null;
    let chartType = 'doughnut';

    // Settings State
    let settingsType = 'expense';
    let selectedSettingsCat = null;

    // --- 3. Drag & Resize Logic ---
    const grid = document.getElementById('grid');
    const widgets = document.querySelectorAll('.widget');
    let draggedItem = null;
    let resizeItem = null;
    const GRID_GAP = 20;
    const ROW_HEIGHT = 60; 

    function initLayout() {
        const savedLayout = JSON.parse(localStorage.getItem('mtf_v6_layout'));
        if (savedLayout) {
            savedLayout.forEach(conf => {
                const el = document.querySelector(`.widget[data-id="${conf.id}"]`);
                if (el) {
                    el.style.gridColumn = `span ${conf.col}`;
                    el.style.gridRow = `span ${conf.row}`;
                    el.style.order = conf.order;
                }
            });
        }
    }
    
    function saveLayout() {
        const layout = Array.from(widgets).map((w, idx) => ({
            id: w.dataset.id,
            col: w.style.gridColumn.split('span ')[1] || '12',
            row: w.style.gridRow.split('span ')[1] || '6',
            order: window.getComputedStyle(w).order || idx
        }));
        localStorage.setItem('mtf_v6_layout', JSON.stringify(layout));
    }
    
    function resetLayout() {
        if(confirm('Á¢∫ÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâÂçÄÂ°äÁöÑ‰ΩçÁΩÆÂíåÂ§ßÂ∞èÂóéÔºü')) {
            localStorage.removeItem('mtf_v6_layout');
            location.reload();
        }
    }

    widgets.forEach(w => {
        const header = w.querySelector('.widget-header');
        header.addEventListener('mousedown', () => w.setAttribute('draggable', 'true'));
        header.addEventListener('mouseup', () => w.setAttribute('draggable', 'false'));
        w.addEventListener('dragstart', function(e) { draggedItem = this; this.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; });
        w.addEventListener('dragend', function() { this.classList.remove('dragging'); this.setAttribute('draggable', 'false'); draggedItem = null; saveLayout(); });
        const resizer = w.querySelector('.resize-handle');
        if(resizer) resizer.addEventListener('mousedown', initResize);
    });

    grid.addEventListener('dragover', function(e) { e.preventDefault(); const afterElement = getDragAfterElement(grid, e.clientY); if (afterElement == null) grid.appendChild(draggedItem); else grid.insertBefore(draggedItem, afterElement); });

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.widget:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; else return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function initResize(e) {
        e.preventDefault(); resizeItem = e.target.closest('.widget'); const startX = e.clientX; const startY = e.clientY; const startW = resizeItem.offsetWidth; const startH = resizeItem.offsetHeight; const colWidth = (grid.offsetWidth - (11 * GRID_GAP)) / 12;
        function doDrag(e) {
            const newW = startW + e.clientX - startX; const newH = startH + e.clientY - startY;
            let colSpan = Math.round((newW + GRID_GAP) / (colWidth + GRID_GAP)); let rowSpan = Math.round((newH + GRID_GAP) / (ROW_HEIGHT + GRID_GAP));
            colSpan = Math.max(3, Math.min(12, colSpan)); rowSpan = Math.max(3, rowSpan);
            resizeItem.style.gridColumn = `span ${colSpan}`; resizeItem.style.gridRow = `span ${rowSpan}`;
            if(resizeItem.id === 'widget-chart' && chartInstance) chartInstance.resize();
        }
        function stopDrag() { window.removeEventListener('mousemove', doDrag); window.removeEventListener('mouseup', stopDrag); saveLayout(); }
        window.addEventListener('mousemove', doDrag); window.addEventListener('mouseup', stopDrag);
    }

    // --- 4. App Logic ---
    
    function updateDateTime() {
        const now = new Date(); const days = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
        document.getElementById('datetime').innerText = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')} (${days[now.getDay()]}) ${now.toLocaleTimeString('zh-TW', {hour12: false})}`;
    }
    setInterval(updateDateTime, 1000); updateDateTime();

    // Init
    initLayout();
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    populateAccountSelects();
    updateCats(); // Initial population
    renderAll();

    function populateAccountSelects() {
        const selects = ['account', 'fromAccount', 'toAccount'];
        selects.forEach(id => {
            const el = document.getElementById(id);
            el.innerHTML = '';
            ACCOUNT_ORDER.forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = ACCOUNTS[key];
                el.appendChild(opt);
            });
        });
    }

    function setType(t) {
        currentType = t;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.type === t));
        
        const isTransfer = t === 'transfer';
        document.getElementById('grp-cat').style.display = isTransfer ? 'none' : 'block';
        document.getElementById('grp-acc').style.display = isTransfer ? 'none' : 'block';
        document.getElementById('grp-trans').style.display = isTransfer ? 'block' : 'none';
        
        if(!isTransfer) {
            document.getElementById('lbl-acc').innerText = t === 'income' ? 'Â≠òÂÖ•Â∏≥Êà∂' : 'ÊîØÂá∫Â∏≥Êà∂';
            updateCats();
        }
    }

    function updateCats() {
        const sel = document.getElementById('category');
        sel.innerHTML = '';
        // Use dynamic categories from state
        const catsObj = categories[currentType]; 
        
        for (const cat in catsObj) {
            const opt = document.createElement('option');
            opt.value = cat; opt.innerText = cat;
            sel.appendChild(opt);
        }
        updateSubCats();
    }

    function updateSubCats() {
        const mainCat = document.getElementById('category').value;
        const subSel = document.getElementById('sub-category');
        subSel.innerHTML = '';
        
        const catsObj = categories[currentType];
        const subList = catsObj[mainCat] || [];
        
        subList.forEach(sub => {
            const opt = document.createElement('option');
            opt.value = sub; opt.innerText = sub;
            subSel.appendChild(opt);
        });
    }

    function addTx(e) {
        e.preventDefault();
        const amt = parseInt(document.getElementById('amount').value);
        if(!amt) return;

        const tx = {
            id: Date.now(),
            date: document.getElementById('date').value,
            desc: document.getElementById('desc').value,
            amount: amt,
            type: currentType
        };

        if(currentType === 'transfer') {
            tx.from = document.getElementById('fromAccount').value;
            tx.to = document.getElementById('toAccount').value;
            if(tx.from === tx.to) return alert('Â∏≥Êà∂Áõ∏Âêå');
            tx.category = 'ËΩâÂ∏≥';
            tx.subCategory = '';
        } else {
            tx.acc = document.getElementById('account').value;
            tx.category = document.getElementById('category').value;
            tx.subCategory = document.getElementById('sub-category').value;
        }

        transactions.unshift(tx);
        saveData();
        renderAll();
        document.getElementById('desc').value = '';
        document.getElementById('amount').value = '';
    }

    function deleteTx(id) {
        openModal('Á¢∫Ë™çÂà™Èô§', 'Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÁ¥ÄÈåÑÂóéÔºü', () => {
            transactions = transactions.filter(t => t.id !== id);
            saveData();
            renderAll();
            closeModal();
        });
    }

    // --- Modal System ---
    const modalOverlay = document.getElementById('modalOverlay');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');

    function openModal(title, contentHTML, onConfirm) {
        modalTitle.innerText = title;
        modalBody.innerHTML = contentHTML;
        modalConfirmBtn.onclick = onConfirm;
        modalOverlay.classList.add('active');
        
        const input = modalBody.querySelector('input');
        if(input) {
            setTimeout(() => { input.focus(); input.select(); }, 50);
            input.onkeydown = (e) => { if(e.key === 'Enter') { e.preventDefault(); modalConfirmBtn.click(); } };
        }
    }

    function closeModal() { modalOverlay.classList.remove('active'); modalConfirmBtn.onclick = null; }

    function editBalance(accKey) {
        let currentBal = 0;
        transactions.forEach(t => {
            if(t.type === 'income' && t.acc === accKey) currentBal += t.amount;
            if(t.type === 'expense' && t.acc === accKey) currentBal -= t.amount;
            if(t.type === 'transfer') {
                if(t.from === accKey) currentBal -= t.amount;
                if(t.to === accKey) currentBal += t.amount;
            }
        });

        const html = `
            <p>ÁõÆÂâçÈ§òÈ°çÔºö$${currentBal.toLocaleString()}</p>
            <p>Ë´ãËº∏ÂÖ•Ê≠£Á¢∫È§òÈ°çÔºö</p>
            <input type="number" id="newBalanceInput" class="modal-input" value="${currentBal}">
        `;

        openModal(`‰øÆÊ≠£ ${ACCOUNTS[accKey]} È§òÈ°ç`, html, () => {
            const input = document.getElementById('newBalanceInput');
            const newBal = parseInt(input.value);
            if(isNaN(newBal)) return;

            const diff = newBal - currentBal;
            if(diff !== 0) {
                const tx = {
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    desc: 'È§òÈ°ç‰øÆÊ≠£',
                    amount: Math.abs(diff),
                    type: diff > 0 ? 'income' : 'expense',
                    acc: accKey,
                    category: 'ÂÖ∂‰ªñ',
                    subCategory: '‰øÆÊ≠£'
                };
                transactions.unshift(tx);
                saveData();
                renderAll();
            }
            closeModal();
        });
    }

    // --- Settings Modal Logic ---
    const settingsModal = document.getElementById('settingsModalOverlay');
    
    function openSettings() {
        settingsModal.classList.add('active');
        selectedSettingsCat = null;
        renderSettingsCats();
        renderSettingsSubs();
    }
    
    function closeSettings() {
        settingsModal.classList.remove('active');
        // Refresh main UI incase categories changed
        updateCats();
    }

    function switchSettingsType(type) {
        settingsType = type;
        document.getElementById('set-tab-expense').classList.toggle('active', type === 'expense');
        document.getElementById('set-tab-income').classList.toggle('active', type === 'income');
        selectedSettingsCat = null;
        renderSettingsCats();
        renderSettingsSubs();
    }

    function renderSettingsCats() {
        const list = document.getElementById('settingsCatList');
        list.innerHTML = '';
        const cats = categories[settingsType];
        
        for (const cat in cats) {
            const li = document.createElement('li');
            li.className = 'settings-item ' + (selectedSettingsCat === cat ? 'active' : '');
            li.innerHTML = `
                <span onclick="selectSettingsCat('${cat}')" style="flex:1;">${cat}</span>
                <span class="btn-del-cat" onclick="delSettingsCat('${cat}')">√ó</span>
            `;
            list.appendChild(li);
        }
    }

    function selectSettingsCat(cat) {
        selectedSettingsCat = cat;
        renderSettingsCats();
        renderSettingsSubs();
    }

    function renderSettingsSubs() {
        const list = document.getElementById('settingsSubList');
        const headerName = document.getElementById('selectedCatName');
        const addGroup = document.getElementById('subAddGroup');
        
        list.innerHTML = '';
        
        if (!selectedSettingsCat) {
            headerName.innerText = '';
            addGroup.style.display = 'none';
            list.innerHTML = '<li style="color:#CCC; text-align:center; padding:20px;">Ë´ãÂÖàÈÅ∏ÊìáÂ∑¶ÂÅ¥‰∏ªÂàÜÈ°û</li>';
            return;
        }

        headerName.innerText = `(${selectedSettingsCat})`;
        addGroup.style.display = 'flex';
        
        const subs = categories[settingsType][selectedSettingsCat] || [];
        subs.forEach((sub, idx) => {
            const li = document.createElement('li');
            li.className = 'settings-item';
            li.innerHTML = `
                <span>${sub}</span>
                <span class="btn-del-cat" onclick="delSettingsSub(${idx})">√ó</span>
            `;
            list.appendChild(li);
        });
    }

    function addSettingsCat() {
        const input = document.getElementById('newCatInput');
        const val = input.value.trim();
        if(!val) return;
        if(categories[settingsType][val]) return alert('ÂàÜÈ°ûÂ∑≤Â≠òÂú®');
        
        categories[settingsType][val] = [];
        saveCats();
        renderSettingsCats();
        input.value = '';
    }

    function delSettingsCat(cat) {
        if(!confirm(`Á¢∫ÂÆöÂà™Èô§‰∏ªÂàÜÈ°û„Äå${cat}„ÄçÂèäÂÖ∂ÊâÄÊúâÁ¥∞È†ÖÔºü`)) return;
        delete categories[settingsType][cat];
        if(selectedSettingsCat === cat) selectedSettingsCat = null;
        saveCats();
        renderSettingsCats();
        renderSettingsSubs();
    }

    function addSettingsSub() {
        const input = document.getElementById('newSubInput');
        const val = input.value.trim();
        if(!val) return;
        
        categories[settingsType][selectedSettingsCat].push(val);
        saveCats();
        renderSettingsSubs();
        input.value = '';
    }

    function delSettingsSub(idx) {
        categories[settingsType][selectedSettingsCat].splice(idx, 1);
        saveCats();
        renderSettingsSubs();
    }

    function saveCats() {
        localStorage.setItem('mtf_v7_cats', JSON.stringify(categories));
    }

    function saveData() { localStorage.setItem('mtf_v6_txs', JSON.stringify(transactions)); }

    function renderAll() {
        renderAccounts();
        renderList();
        renderChart();
    }

    function renderAccounts() {
        const bals = { ctbc: 0, cathay: 0, taishin: 0, cash: 0 };
        transactions.forEach(t => {
            if(t.type === 'income') bals[t.acc] += t.amount;
            if(t.type === 'expense') bals[t.acc] -= t.amount;
            if(t.type === 'transfer') {
                bals[t.from] -= t.amount;
                bals[t.to] += t.amount;
            }
        });

        const container = document.getElementById('accounts-container');
        container.innerHTML = '';

        // Render Total Card (Always on top, full width)
        const totalAmount = Object.values(bals).reduce((a, b) => a + b, 0);
        const totalDiv = document.createElement('div');
        totalDiv.className = 'acc-card acc-total';
        totalDiv.innerHTML = `<div class="acc-label">üí∞ Á∏ΩË≥áÁî¢</div><div class="acc-val">$${totalAmount.toLocaleString()}</div>`;
        container.appendChild(totalDiv);

        // Render individual accounts in specified order
        ACCOUNT_ORDER.forEach(k => {
            const div = document.createElement('div');
            div.className = `acc-card acc-${k}`;
            div.onclick = () => editBalance(k);
            div.innerHTML = `<div class="acc-label">${ACCOUNTS[k]}</div><div class="acc-val">$${bals[k].toLocaleString()}</div>`;
            container.appendChild(div);
        });
    }

    function renderList() {
        const listEl = document.getElementById('txList');
        const search = document.getElementById('search').value.toLowerCase();
        listEl.innerHTML = '';
        
        const filtered = transactions.filter(t => t.desc.toLowerCase().includes(search) || t.category.includes(search));
        
        filtered.slice(0, 100).forEach(t => {
            const div = document.createElement('div');
            div.className = `tx-item type-${t.type}`;
            let info = t.type === 'transfer' ? `${ACCOUNTS[t.from]} ‚Üí ${ACCOUNTS[t.to]}` : `${ACCOUNTS[t.acc]} ¬∑ ${t.category}`;
            if(t.subCategory) info += ` - ${t.subCategory}`;
            
            let amtClass = t.type === 'income' ? 'pos' : (t.type === 'expense' ? 'neg' : '');
            let sign = t.type === 'income' ? '+' : (t.type === 'expense' ? '-' : '');
            
            div.innerHTML = `
                <div class="tx-info">
                    <h4>${t.desc} <span class="tx-badge">${t.category}</span></h4>
                    <p>${t.date} ¬∑ ${info}</p>
                </div>
                <div style="display:flex;align-items:center;gap:10px;">
                    <span class="tx-amt ${amtClass}">${sign}$${t.amount.toLocaleString()}</span>
                    <button style="border:none;background:none;color:#ddd;cursor:pointer;" onclick="deleteTx(${t.id})">√ó</button>
                </div>
            `;
            listEl.appendChild(div);
        });
    }

    function updateChartType(t) {
        chartType = t;
        renderChart();
    }

    function renderChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        const dataMap = {};
        transactions.filter(t => t.type === 'expense').forEach(t => {
            dataMap[t.category] = (dataMap[t.category] || 0) + t.amount;
        });

        const colors = ['#D58989', '#C59D7F', '#A3B18A', '#8D99AE', '#E9C46A', '#2A9D8F', '#F4A261'];

        chartInstance = new Chart(ctx, {
            type: chartType,
            data: {
                labels: Object.keys(dataMap),
                datasets: [{
                    label: 'ÊîØÂá∫ÈáëÈ°ç',
                    data: Object.values(dataMap),
                    backgroundColor: colors,
                    borderRadius: 5,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
</script>

</body>
</html>
