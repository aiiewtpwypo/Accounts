<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milk Tea Finance v6.3</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸ --- */
        :root {
            --bg-color: #F7F5F2;
            --card-bg: #FFFFFF;
            --primary-color: #C59D7F;
            --primary-dark: #8D7B68;
            --text-main: #4A403A;
            --text-muted: #9C8E83;
            --success-color: #A3B18A;
            --danger-color: #D58989;
            --transfer-color: #8D99AE;
            
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
            --shadow-soft: 0 10px 40px -10px rgba(197, 157, 127, 0.15);
            --shadow-hover: 0 20px 50px -12px rgba(197, 157, 127, 0.25);
            
            --grid-col-width: 1fr;
            --grid-row-height: 60px;
            --grid-gap: 20px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Nunito', 'Noto Sans TC', sans-serif; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
            background-image: radial-gradient(var(--primary-color) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* --- Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(12px);
            padding: 15px 30px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(197, 157, 127, 0.08);
            flex-wrap: wrap;
            gap: 15px;
            border: 1px solid rgba(255,255,255,0.8);
        }
        
        .header-left h1 {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary-dark);
            letter-spacing: -0.5px;
            margin: 0;
        }
        
        .datetime-display {
            font-family: 'Nunito', 'Noto Sans TC', monospace;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary-dark);
            background: linear-gradient(135deg, #FFF 0%, #F9F9F9 100%);
            padding: 8px 20px;
            border-radius: 50px;
            border: 1px solid #EAEAEA;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.02), 0 2px 10px rgba(197, 157, 127, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: 0.5px;
        }
        .datetime-display::before { content: 'ğŸ•’'; font-size: 1.1rem; }

        /* --- Grid System --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-auto-rows: var(--grid-row-height);
            gap: var(--grid-gap);
            position: relative;
        }

        .widget {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            transition: box-shadow 0.2s, transform 0.2s;
            border: 1px solid rgba(255,255,255,0.5);
        }
        
        .widget:hover { box-shadow: var(--shadow-hover); z-index: 10; }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            cursor: grab;
            padding-bottom: 8px;
            border-bottom: 2px solid #F8F6F4;
            flex-shrink: 0;
        }
        .widget-header:active { cursor: grabbing; }

        .widget-title {
            font-weight: 800;
            color: var(--primary-dark);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            pointer-events: none;
        }
        
        .drag-handle { color: var(--text-muted); opacity: 0.5; font-size: 1.2rem; margin-right: 10px; }

        .resize-handle {
            position: absolute;
            bottom: 0; right: 0; width: 20px; height: 20px;
            cursor: nwse-resize;
            background: linear-gradient(135deg, transparent 50%, var(--primary-color) 50%);
            opacity: 0; transition: opacity 0.2s;
            border-bottom-right-radius: var(--radius-lg);
            z-index: 20;
        }
        .widget:hover .resize-handle { opacity: 0.8; }

        /* --- Widget Content Specifics --- */
        
        /* 1. Accounts Widget */
        .accounts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            height: 100%;
            overflow-y: auto;
        }
        .acc-card {
            background: #FAFAFA;
            padding: 15px;
            border-radius: 16px;
            border-left: 5px solid #CCC;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .acc-card:hover { transform: translateY(-2px); background: #FFF; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .acc-ctbc { border-left-color: #009E96; }
        .acc-cathay { border-left-color: #26A600; }
        .acc-taishin { border-left-color: #E60012; }
        .acc-cash { border-left-color: #D4A373; }
        
        /* ç¸½é‡‘é¡å¡ç‰‡æ¨£å¼ */
        .acc-total { 
            border-left-color: var(--primary-dark); 
            background: linear-gradient(to right bottom, #FFF, #FDF7F2);
            cursor: default; /* ä¸å¯ç·¨è¼¯ */
        }
        .acc-total:hover { transform: none; background: linear-gradient(to right bottom, #FFF, #FDF7F2); box-shadow: none; }

        .acc-val { 
            font-size: 1.4rem; 
            font-weight: 800; 
            color: var(--text-main); 
            margin-top: 5px; 
            position: relative;
        }
        /* åªæœ‰å¯ç·¨è¼¯çš„å¡ç‰‡æ‰é¡¯ç¤ºç·¨è¼¯æç¤º */
        .acc-card:not(.acc-total):hover .acc-val::after {
            content: 'âœ'; position: absolute; right: 0; font-size: 0.8rem; color: var(--primary-color);
        }
        .acc-label { font-size: 0.85rem; color: var(--text-muted); font-weight: 700; }

        /* 2. Input Widget (Compact Mode) */
        .input-scroll-area { 
            overflow-y: auto; 
            flex: 1; 
            padding-right: 5px; 
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        .type-tabs { 
            display: flex; 
            background: #F4F1EE; 
            border-radius: 10px; 
            padding: 3px; 
            margin-bottom: 10px; 
            flex-shrink: 0;
        }
        .tab-btn { 
            flex: 1; padding: 6px;
            border: none; background: transparent; cursor: pointer; 
            border-radius: 8px; color: var(--text-muted); font-weight: 700; transition:0.2s; 
            font-size: 0.9rem;
        }
        .tab-btn.active { background: #FFF; color: var(--text-main); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-btn[data-type="expense"].active { color: var(--danger-color); }
        .tab-btn[data-type="income"].active { color: var(--success-color); }
        
        .input-group { margin-bottom: 8px; }
        .input-label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 3px; font-weight: 700; }
        .form-control { 
            width: 100%; 
            padding: 8px 10px; 
            border: 2px solid #F0EAE6; 
            border-radius: 10px; 
            outline: none; 
            background: #FAFAFA; 
            font-size: 0.95rem; 
            height: 38px;
        }
        .form-control:focus { border-color: var(--primary-color); background: #FFF; }
        
        .btn-submit { 
            width: 100%; 
            padding: 10px;
            background: var(--primary-color); 
            color: white; border: none; 
            border-radius: 12px; 
            font-weight: 800; 
            cursor: pointer; 
            margin-top: auto;
            font-size: 1rem; 
            transition: 0.2s;
        }
        .btn-submit:hover { background: var(--primary-dark); transform: translateY(-1px); }

        /* 3. List Widget */
        .list-controls { margin-bottom: 10px; }
        .search-input { width: 100%; padding: 8px 15px; border-radius: 20px; border: 2px solid #F0EAE6; outline:none; }
        .tx-list { overflow-y: auto; flex: 1; padding-right: 5px; }
        .tx-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #FAFAFA; border-radius: 12px; margin-bottom: 6px; transition: 0.2s; border-left: 4px solid transparent; }
        .tx-item:hover { background: #FFF; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .type-expense { border-left-color: var(--danger-color); }
        .type-income { border-left-color: var(--success-color); }
        .type-transfer { border-left-color: var(--transfer-color); }
        .tx-info h4 { font-size: 0.9rem; color: var(--text-main); margin-bottom: 2px; }
        .tx-info p { font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px; }
        .tx-badge { background: #EAEAEA; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
        .tx-amt { font-weight: 800; font-size: 0.95rem; }
        .tx-amt.neg { color: var(--danger-color); }
        .tx-amt.pos { color: var(--success-color); }

        /* 4. Chart Widget */
        .chart-wrapper { position: relative; width: 100%; height: 100%; min-height: 250px; }

        /* --- Custom Modal --- */
        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(4px);
            display: none; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; transition: opacity 0.3s;
        }
        .custom-modal-overlay.active { display: flex; opacity: 1; }
        .custom-modal {
            background: white; width: 90%; max-width: 400px;
            border-radius: 20px; padding: 25px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            transform: scale(0.9); transition: transform 0.3s;
        }
        .custom-modal-overlay.active .custom-modal { transform: scale(1); }
        .modal-title { font-size: 1.2rem; font-weight: 800; color: var(--primary-dark); margin-bottom: 15px; }
        .modal-body { margin-bottom: 20px; color: var(--text-main); font-size: 0.95rem; }
        .modal-input { width: 100%; padding: 12px; border: 2px solid #F0EAE6; border-radius: 12px; font-size: 1.1rem; outline: none; margin-top: 10px; }
        .modal-input:focus { border-color: var(--primary-color); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-btn { padding: 10px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; }
        .modal-btn-cancel { background: #F4F1EE; color: var(--text-muted); }
        .modal-btn-confirm { background: var(--primary-color); color: white; }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid { display: flex; flex-direction: column; height: auto; }
            .widget { height: auto !important; min-height: 300px; }
            .resize-handle { display: none; }
            header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .header-right { width: 100%; justify-content: center; }
            .datetime-display { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-left">
            <h1>Milk Tea Finance</h1>
        </div>
        <div class="header-right">
            <!-- New Detailed Date Time -->
            <div class="datetime-display" id="datetime">Loading...</div>
        </div>
    </header>

    <div class="dashboard-grid" id="grid">
        
        <!-- Widget 1: Accounts -->
        <div class="widget" id="widget-accounts" data-id="accounts" style="grid-column: span 12; grid-row: span 3;">
            <div class="resize-handle"></div>
            <div class="widget-header">
                <div class="widget-title"><span class="drag-handle">â‹®â‹®</span> ğŸ’³ å¸³æˆ¶ç¸½è¦½</div>
                <div style="font-size:0.75rem; color:var(--text-muted);">é»æ“Šå¡ç‰‡å¯ä¿®æ­£é¤˜é¡</div>
            </div>
            <div class="accounts-container" id="accounts-container">
                <!-- JS Populated -->
            </div>
        </div>

        <!-- Widget 2: Input -->
        <div class="widget" id="widget-input" data-id="input" style="grid-column: span 4; grid-row: span 8;">
            <div class="resize-handle"></div>
            <div class="widget-header">
                <div class="widget-title"><span class="drag-handle">â‹®â‹®</span> âœï¸ æ–°å¢ç´€éŒ„</div>
            </div>
            <div class="input-scroll-area">
                <div class="type-tabs">
                    <button class="tab-btn active" onclick="setType('expense')" data-type="expense">æ”¯å‡º</button>
                    <button class="tab-btn" onclick="setType('income')" data-type="income">æ”¶å…¥</button>
                    <button class="tab-btn" onclick="setType('transfer')" data-type="transfer">è½‰å¸³</button>
                </div>
                <form id="txForm" onsubmit="addTx(event)">
                    <div class="input-group">
                        <label class="input-label">æ—¥æœŸ</label>
                        <input type="date" id="date" class="form-control" required>
                    </div>
                    <div class="input-group" id="grp-cat">
                        <label class="input-label">åˆ†é¡</label>
                        <select id="category" class="form-control"></select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">é …ç›® / å‚™è¨»</label>
                        <input type="text" id="desc" class="form-control" placeholder="è¼¸å…¥å‚™è¨»..." required>
                    </div>
                    <!-- Single Account -->
                    <div class="input-group" id="grp-acc">
                        <label class="input-label" id="lbl-acc">æ”¯å‡ºå¸³æˆ¶</label>
                        <select id="account" class="form-control">
                            <option value="cash">ç¾é‡‘</option>
                            <option value="ctbc">ä¸­åœ‹ä¿¡è¨—</option>
                            <option value="cathay">åœ‹æ³°ä¸–è¯</option>
                            <option value="taishin">å°æ–°éŠ€è¡Œ</option>
                        </select>
                    </div>
                    <!-- Transfer -->
                    <div class="input-group" id="grp-trans" style="display:none;">
                        <label class="input-label">è½‰å‡º (From)</label>
                        <select id="fromAccount" class="form-control">
                            <option value="ctbc">ä¸­åœ‹ä¿¡è¨—</option>
                            <option value="cathay">åœ‹æ³°ä¸–è¯</option>
                            <option value="taishin">å°æ–°éŠ€è¡Œ</option>
                            <option value="cash">ç¾é‡‘</option>
                        </select>
                        <div style="text-align:center; margin:2px; font-size:0.8rem; color:#ccc;">â†“</div>
                        <label class="input-label">è½‰å…¥ (To)</label>
                        <select id="toAccount" class="form-control">
                            <option value="cash">ç¾é‡‘</option>
                            <option value="ctbc">ä¸­åœ‹ä¿¡è¨—</option>
                            <option value="cathay">åœ‹æ³°ä¸–è¯</option>
                            <option value="taishin">å°æ–°éŠ€è¡Œ</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">é‡‘é¡</label>
                        <input type="number" id="amount" class="form-control" placeholder="0" required min="1">
                    </div>
                    <button class="btn-submit">ç¢ºèªæ–°å¢</button>
                </form>
            </div>
        </div>

        <!-- Widget 3: List -->
        <div class="widget" id="widget-list" data-id="list" style="grid-column: span 8; grid-row: span 8;">
            <div class="resize-handle"></div>
            <div class="widget-header">
                <div class="widget-title"><span class="drag-handle">â‹®â‹®</span> ğŸ§¾ è¿‘æœŸäº¤æ˜“</div>
            </div>
            <div class="list-controls">
                <input type="text" id="search" class="search-input" placeholder="ğŸ” æœå°‹ç´€éŒ„..." onkeyup="renderList()">
            </div>
            <div class="tx-list" id="txList"></div>
        </div>

        <!-- Widget 4: Chart -->
        <div class="widget" id="widget-chart" data-id="chart" style="grid-column: span 12; grid-row: span 7;">
            <div class="resize-handle"></div>
            <div class="widget-header">
                <div class="widget-title"><span class="drag-handle">â‹®â‹®</span> ğŸ“Š è²¡å‹™åˆ†æ (æ”¯å‡ºä½”æ¯”)</div>
                <select onchange="updateChartType(this.value)" style="border:1px solid #ddd; border-radius:5px; padding:2px; font-size:0.9rem;">
                    <option value="doughnut">åœ“é¤…åœ–</option>
                    <option value="bar">é•·æ¢åœ–</option>
                </select>
            </div>
            <div class="chart-wrapper">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

    </div>
</div>

<!-- Custom Modal -->
<div class="custom-modal-overlay" id="modalOverlay">
    <div class="custom-modal">
        <div class="modal-title" id="modalTitle">æ¨™é¡Œ</div>
        <div class="modal-body" id="modalBody">å…§å®¹</div>
        <div class="modal-actions">
            <button class="modal-btn modal-btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="modal-btn modal-btn-confirm" id="modalConfirmBtn">ç¢ºèª</button>
        </div>
    </div>
</div>

<script>
    // --- 1. Data Config ---
    const ACCOUNTS = { ctbc: 'ä¸­åœ‹ä¿¡è¨—', cathay: 'åœ‹æ³°ä¸–è¯', taishin: 'å°æ–°éŠ€è¡Œ', cash: 'ç¾é‡‘' };
    const CATS = {
        expense: ['é¤é£²', 'äº¤é€š', 'è³¼ç‰©', 'å¨›æ¨‚', 'å¸³å–®', 'å­¸ç¿’', 'å…¶ä»–'],
        income: ['è–ªæ°´', 'çé‡‘', 'æŠ•è³‡', 'å…¶ä»–']
    };
    
    // --- 2. State ---
    let transactions = JSON.parse(localStorage.getItem('mtf_v6_txs')) || [];
    let currentType = 'expense';
    let chartInstance = null;
    let chartType = 'doughnut';

    // --- 3. Drag & Resize Logic ---
    const grid = document.getElementById('grid');
    const widgets = document.querySelectorAll('.widget');
    let draggedItem = null;
    let resizeItem = null;
    const GRID_GAP = 20;
    const ROW_HEIGHT = 60; 

    function initLayout() {
        const savedLayout = JSON.parse(localStorage.getItem('mtf_v6_layout'));
        if (savedLayout) {
            savedLayout.forEach(conf => {
                const el = document.querySelector(`.widget[data-id="${conf.id}"]`);
                if (el) {
                    el.style.gridColumn = `span ${conf.col}`;
                    el.style.gridRow = `span ${conf.row}`;
                    el.style.order = conf.order;
                }
            });
        }
    }
    
    function saveLayout() {
        const layout = Array.from(widgets).map((w, idx) => ({
            id: w.dataset.id,
            col: w.style.gridColumn.split('span ')[1] || '12',
            row: w.style.gridRow.split('span ')[1] || '6',
            order: window.getComputedStyle(w).order || idx
        }));
        localStorage.setItem('mtf_v6_layout', JSON.stringify(layout));
    }

    widgets.forEach(w => {
        const header = w.querySelector('.widget-header');
        header.addEventListener('mousedown', () => w.setAttribute('draggable', 'true'));
        header.addEventListener('mouseup', () => w.setAttribute('draggable', 'false'));
        
        w.addEventListener('dragstart', function(e) {
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        });
        w.addEventListener('dragend', function() {
            this.classList.remove('dragging');
            this.setAttribute('draggable', 'false');
            draggedItem = null;
            saveLayout();
        });
        
        const resizer = w.querySelector('.resize-handle');
        if(resizer) resizer.addEventListener('mousedown', initResize);
    });

    grid.addEventListener('dragover', function(e) {
        e.preventDefault();
        const afterElement = getDragAfterElement(grid, e.clientY);
        if (afterElement == null) grid.appendChild(draggedItem);
        else grid.insertBefore(draggedItem, afterElement);
    });

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.widget:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
            else return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function initResize(e) {
        e.preventDefault();
        resizeItem = e.target.closest('.widget');
        const startX = e.clientX;
        const startY = e.clientY;
        const startW = resizeItem.offsetWidth;
        const startH = resizeItem.offsetHeight;
        const colWidth = (grid.offsetWidth - (11 * GRID_GAP)) / 12;

        function doDrag(e) {
            const newW = startW + e.clientX - startX;
            const newH = startH + e.clientY - startY;
            
            let colSpan = Math.round((newW + GRID_GAP) / (colWidth + GRID_GAP));
            let rowSpan = Math.round((newH + GRID_GAP) / (ROW_HEIGHT + GRID_GAP));
            
            colSpan = Math.max(3, Math.min(12, colSpan));
            rowSpan = Math.max(3, rowSpan);

            resizeItem.style.gridColumn = `span ${colSpan}`;
            resizeItem.style.gridRow = `span ${rowSpan}`;
            
            if(resizeItem.id === 'widget-chart' && chartInstance) chartInstance.resize();
        }

        function stopDrag() {
            window.removeEventListener('mousemove', doDrag);
            window.removeEventListener('mouseup', stopDrag);
            saveLayout();
        }

        window.addEventListener('mousemove', doDrag);
        window.addEventListener('mouseup', stopDrag);
    }

    // --- 4. App Logic ---
    
    // DateTime Logic (Enhanced)
    function updateDateTime() {
        const now = new Date();
        const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const dateStr = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')}`;
        const dayStr = days[now.getDay()];
        const timeStr = now.toLocaleTimeString('zh-TW', {hour12: false});
        document.getElementById('datetime').innerText = `${dateStr} (${dayStr}) ${timeStr}`;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // Init
    initLayout();
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    updateCats();
    renderAll();

    function setType(t) {
        currentType = t;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.type === t));
        
        const isTransfer = t === 'transfer';
        document.getElementById('grp-cat').style.display = isTransfer ? 'none' : 'block';
        document.getElementById('grp-acc').style.display = isTransfer ? 'none' : 'block';
        document.getElementById('grp-trans').style.display = isTransfer ? 'block' : 'none';
        
        if(!isTransfer) {
            document.getElementById('lbl-acc').innerText = t === 'income' ? 'å­˜å…¥å¸³æˆ¶' : 'æ”¯å‡ºå¸³æˆ¶';
            updateCats();
        }
    }

    function updateCats() {
        const sel = document.getElementById('category');
        sel.innerHTML = '';
        CATS[currentType].forEach(c => {
            const opt = document.createElement('option');
            opt.value = c; opt.innerText = c;
            sel.appendChild(opt);
        });
    }

    function addTx(e) {
        e.preventDefault();
        const amt = parseInt(document.getElementById('amount').value);
        if(!amt) return;

        const tx = {
            id: Date.now(),
            date: document.getElementById('date').value,
            desc: document.getElementById('desc').value,
            amount: amt,
            type: currentType
        };

        if(currentType === 'transfer') {
            tx.from = document.getElementById('fromAccount').value;
            tx.to = document.getElementById('toAccount').value;
            if(tx.from === tx.to) return alert('å¸³æˆ¶ç›¸åŒ');
            tx.category = 'è½‰å¸³';
        } else {
            tx.acc = document.getElementById('account').value;
            tx.category = document.getElementById('category').value;
        }

        transactions.unshift(tx);
        saveData();
        renderAll();
        document.getElementById('desc').value = '';
        document.getElementById('amount').value = '';
    }

    function deleteTx(id) {
        openModal('ç¢ºèªåˆªé™¤', 'ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ', () => {
            transactions = transactions.filter(t => t.id !== id);
            saveData();
            renderAll();
            closeModal();
        });
    }

    // Modal System - Fixed logic to avoid replaceChild error
    const modalOverlay = document.getElementById('modalOverlay');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');

    function openModal(title, contentHTML, onConfirm) {
        modalTitle.innerText = title;
        modalBody.innerHTML = contentHTML;
        
        // Correct way to update event listener without replaceChild
        modalConfirmBtn.onclick = onConfirm;
        
        modalOverlay.classList.add('active');
        
        // Auto focus input if exists
        const input = modalBody.querySelector('input');
        if(input) setTimeout(() => input.focus(), 100);
    }

    function closeModal() {
        modalOverlay.classList.remove('active');
        modalConfirmBtn.onclick = null; // Clean up
    }

    // New: Edit Balance Directly using Modal
    function editBalance(accKey) {
        let currentBal = 0;
        transactions.forEach(t => {
            if(t.type === 'income' && t.acc === accKey) currentBal += t.amount;
            if(t.type === 'expense' && t.acc === accKey) currentBal -= t.amount;
            if(t.type === 'transfer') {
                if(t.from === accKey) currentBal -= t.amount;
                if(t.to === accKey) currentBal += t.amount;
            }
        });

        const html = `
            <p>ç›®å‰é¤˜é¡ï¼š$${currentBal.toLocaleString()}</p>
            <p>è«‹è¼¸å…¥æ­£ç¢ºé¤˜é¡ï¼š</p>
            <input type="number" id="newBalanceInput" class="modal-input" value="${currentBal}">
        `;

        openModal(`ä¿®æ­£ ${ACCOUNTS[accKey]} é¤˜é¡`, html, () => {
            const input = document.getElementById('newBalanceInput');
            const newBal = parseInt(input.value);
            if(isNaN(newBal)) return;

            const diff = newBal - currentBal;
            if(diff !== 0) {
                const tx = {
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    desc: 'é¤˜é¡ä¿®æ­£',
                    amount: Math.abs(diff),
                    type: diff > 0 ? 'income' : 'expense',
                    acc: accKey,
                    category: 'å…¶ä»–'
                };
                transactions.unshift(tx);
                saveData();
                renderAll();
            }
            closeModal();
        });
    }

    function saveData() { localStorage.setItem('mtf_v6_txs', JSON.stringify(transactions)); }

    // --- 5. Render Functions ---
    function renderAll() {
        renderAccounts();
        renderList();
        renderChart();
    }

    function renderAccounts() {
        const bals = { ctbc: 0, cathay: 0, taishin: 0, cash: 0 };
        transactions.forEach(t => {
            if(t.type === 'income') bals[t.acc] += t.amount;
            if(t.type === 'expense') bals[t.acc] -= t.amount;
            if(t.type === 'transfer') {
                bals[t.from] -= t.amount;
                bals[t.to] += t.amount;
            }
        });

        const container = document.getElementById('accounts-container');
        container.innerHTML = '';

        // Calculate Total
        const totalAmount = Object.values(bals).reduce((a, b) => a + b, 0);

        // Render Total Card
        const totalDiv = document.createElement('div');
        totalDiv.className = 'acc-card acc-total';
        totalDiv.style.cursor = 'default'; // Not editable
        totalDiv.innerHTML = `<div class="acc-label">ğŸ’° ç¸½è³‡ç”¢</div><div class="acc-val" style="font-size:1.5rem; color:var(--primary-dark);">$${totalAmount.toLocaleString()}</div>`;
        container.appendChild(totalDiv);

        for(const [k, v] of Object.entries(bals)) {
            const div = document.createElement('div');
            div.className = `acc-card acc-${k}`;
            // Use the new editBalance
            div.onclick = () => editBalance(k);
            div.innerHTML = `<div class="acc-label">${ACCOUNTS[k]}</div><div class="acc-val">$${v.toLocaleString()}</div>`;
            container.appendChild(div);
        }
    }

    function renderList() {
        const listEl = document.getElementById('txList');
        const search = document.getElementById('search').value.toLowerCase();
        listEl.innerHTML = '';
        
        const filtered = transactions.filter(t => t.desc.toLowerCase().includes(search) || t.category.includes(search));
        
        filtered.slice(0, 100).forEach(t => {
            const div = document.createElement('div');
            div.className = `tx-item type-${t.type}`;
            let info = t.type === 'transfer' ? `${ACCOUNTS[t.from]} â†’ ${ACCOUNTS[t.to]}` : `${ACCOUNTS[t.acc]} Â· ${t.category}`;
            let amtClass = t.type === 'income' ? 'pos' : (t.type === 'expense' ? 'neg' : '');
            let sign = t.type === 'income' ? '+' : (t.type === 'expense' ? '-' : '');
            
            div.innerHTML = `
                <div class="tx-info">
                    <h4>${t.desc} <span class="tx-badge">${t.category}</span></h4>
                    <p>${t.date} Â· ${info}</p>
                </div>
                <div style="display:flex;align-items:center;gap:10px;">
                    <span class="tx-amt ${amtClass}">${sign}$${t.amount.toLocaleString()}</span>
                    <button style="border:none;background:none;color:#ddd;cursor:pointer;" onclick="deleteTx(${t.id})">Ã—</button>
                </div>
            `;
            listEl.appendChild(div);
        });
    }

    function updateChartType(t) {
        chartType = t;
        renderChart();
    }

    function renderChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        const dataMap = {};
        transactions.filter(t => t.type === 'expense').forEach(t => {
            dataMap[t.category] = (dataMap[t.category] || 0) + t.amount;
        });

        const colors = ['#D58989', '#C59D7F', '#A3B18A', '#8D99AE', '#E9C46A', '#2A9D8F', '#F4A261'];

        chartInstance = new Chart(ctx, {
            type: chartType,
            data: {
                labels: Object.keys(dataMap),
                datasets: [{
                    label: 'æ”¯å‡ºé‡‘é¡',
                    data: Object.values(dataMap),
                    backgroundColor: colors,
                    borderRadius: 5,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
</script>

</body>
</html>
